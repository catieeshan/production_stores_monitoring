{% extends "stores_home.html" %}

{% block stores_content %}

<h2>‚¨Ü Issue to Production / Consumption</h2>

{% if error %}
<div style="
    background:#fee2e2;
    color:#b91c1c;
    padding:10px;
    margin-bottom:15px;
    border-radius:6px;
    font-weight:600;">
    ‚ùå {{ error }}
</div>
{% endif %}

<hr>

<!-- ============================= -->
<!-- ISSUE ENTRY FORM -->
<!-- ============================= -->
<div class="form-card">

    <form method="post" action="/stores/save_issue">

        <div class="form-row">

            <label>Date</label>
            <input type="date" name="date" required>

            <label>Item Code</label>
            <select name="item" required>
                {% for i in items %}
                    <option value="{{ i.code }}">{{ i.label }}</option>
                {% endfor %}
            </select>

            <label>Quantity</label>
            <input type="number" step="0.01" name="qty" required>

            <label>Issue Purpose</label>
            <select name="purpose" required>
                {% for p in purposes %}
                    <option>{{ p }}</option>
                {% endfor %}
            </select>

            <label>Issued By</label>
            <input type="text" name="issued_by" required>

            <label>Remarks</label>
            <input type="text" name="remarks">

        </div>

        <div class="form-actions">
            <button class="action-save">üíæ Save Issue</button>
        </div>

    </form>

</div>

<hr>

<!-- ============================= -->
<!-- ISSUE REGISTER -->
<!-- ============================= -->
<h3>üìã Issue Register</h3>

<div class="table-container">
    <table class="modern-table">

        <thead>
            <tr>
                <th>Date</th>
                <th>Item Code</th>
                <th>Qty</th>
                <th>Purpose</th>
                <th>Issued By</th>
                <th>Remarks</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>

            {% for r in records %}
            {% if request.args.get("edit_ts") == r["Timestamp"] %}

            <!-- ================= EDIT MODE ================= -->
            <tr>
                <form method="post" action="/stores/edit_issue">

                    <input type="hidden" name="old_timestamp" value="{{ r['Timestamp'] }}">

                    <td align="center">
                        <input class="table-input" type="date" name="date" value="{{ r['Date'] }}" required>
                    </td>

                    <td align="center">
                        <select class="table-input" name="item">
                            {% for i in items %}
                                <option value="{{ i.code }}" {% if i.code == r["Item"] %}selected{% endif %}>
                                    {{ i.label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <td align="center">
                        <input class="table-input" type="number" step="0.01" name="qty" value="{{ r['Qty'] }}" required>
                    </td>

                    <td align="center">
                        <select class="table-input" name="purpose">
                            {% for p in purposes %}
                                <option value="{{ p }}" {% if p in r["Remarks"] %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    <td align="center">
                        <input class="table-input" name="issued_by"
                               value="{{ r['Remarks'].split('|')[1].replace('Issued By:','').strip() }}"
                               required>
                    </td>

                    <td align="center">
                        <input class="table-input" name="remarks"
                               value="{{ r['Remarks'].split('|')[-1] if '|' in r['Remarks'] else '' }}">
                    </td>

                    <!-- ACTION -->
                    <td align="center" class="table-actions">
                        <input type="password" name="code" placeholder="Code" required style="width:70px;">
                        <button class="action-save">üíæ Save</button>
                        <a class="action-cancel" href="/stores/issue">‚ùå Cancel</a>
                    </td>

                </form>
            </tr>

            {% else %}

            <!-- ================= NORMAL ROW ================= -->
            <tr>

                <td align="center">{{ r["Date"] }}</td>
                <td align="center">{{ r["Item"] }}</td>
                <td align="center">{{ r["Qty"] }}</td>

                <td align="center">
                    {{ r["Remarks"].split('|')[0] }}
                </td>

                <td align="center">
                    {{ r["Remarks"].split('|')[1].replace("Issued By:","") }}
                </td>

                <td align="center">
                    {% if "|" in r["Remarks"] %}
                        {{ r["Remarks"].split('|')[-1] }}
                    {% endif %}
                </td>

                <!-- ACTION -->
                <td align="center">

                    <a class="action-btn action-edit"
                       href="/stores/issue?edit_ts={{ r['Timestamp'] }}">
                       ‚úèÔ∏è Edit
                    </a>

                    <a class="action-btn action-delete"
                       onclick="deleteIssue(`{{ r['Timestamp'] }}`)">
                       üóëÔ∏è Delete
                    </a>

                </td>

            </tr>

            {% endif %}
            {% endfor %}

        </tbody>

    </table>
</div>

<!-- ================= DELETE SCRIPT ================= -->
<script>
function deleteIssue(ts){

    let code = prompt("Enter verification code:");

    if(!code) return;

    let form = new FormData();
    form.append("timestamp", ts);
    form.append("code", code);

    fetch("/stores/delete_issue",{
        method:"POST",
        body:form
    })
    .then(res=>{
        if(res.status==200){
            location.reload();
        }else{
            alert("Invalid code");
        }
    });
}
</script>

{% endblock %}